# Система управления стажировками компании Digital Spirit.

Для управления стажировками компании Digital Spirit будет использоваться
описанная ниже система. Ваша задача реализовать backend приложение для
системы управления стажировками. Вы реализуете REST API, предполагая, что в дальнейшем с
ним будет взаимодействовать реализованное frontend-приложение или различные клиенты.
Вся бизнес-логика должна находиться на стороне backend.

## Требования к системе:

- Spring Boot;
- Spring Security;
- REST API;
- PostgreSQL;
- Flyway;
- Gitlab CE;
- Docker.

## Задачи системы:

- Учёт стажировок;
- Учёт участников;
- Архив информации о предыдущих стажировках и участниках;
- Хранение занятий и задач;
- Управление репозиториями участников;
- Учёт успеваемости участников.

## Описание системы и функциональные требования:

Система и все компоненты, должны разворачиваться с помощью docker-compose,
а необходимые для работы данные хранить в ./data.
REST API должно быть разделено на три части: публичная, пользовательская и административная.
Административная часть должна быть доступна пользователям с ролью admin.
Пользовательская информация должна быть доступна только владельцу данных.
Соответственно, публичная доступна всем.
Приватные части API должно быть защищены с помощью Spring Security.
У сущностей могут быть статусы. Проект должен быть покрыт unit тестами.
Все api должны документированы в swagger. Классы должны быть документированы.

Минимальный набор атрибутов для стажировки: Название, описание, дата начала, дата окончания,
дата окончания записи, статус стажировки. Записаться на курс можно только пока доступна запись.

Для записи на стажировку пользователь должен предоставить следующие данные:
ФИО, e-mail, мобильный номер, username, telegram id, информация о себе, дата рождения,
город проживания, статус обучения (студент, закончил обучение, не имею профильного образования),
ВУЗ/СУЗ, факультет, специальность, курс.
Допускается множественная запись на стажировки, т.е. один человек может несколько раз записываться
на стажировки компании, но в конкретную стажировку только один раз. При записи необходимо проверять
не проходил ли данный человек стажировку ранее и если проходил, то обновлять информацию.

Если участник отчисляется со стажировки его успеваемость и пользовательская информация должны храниться в архиве,
так же как и сама стажировка.

У каждой стажировки есть уникальная структура занятий и задач.
У каждого занятия есть множество задач. У каждой задачи есть название и эталонный репозиторий в gitlab.
В административной части должна быть возможность публикации занятия.
После публикации занятия в gitlab должны быть созданы репозитории всех задач занятия для каждого активного участника.
Т.е. создан fork эталонного репозитория.
В случае ошибки необходимо создать сообщение для всех пользователей с ролью admin.

В административной части должна быть возможность проверить задачи занятия.
После запуска процесса в gitlab проверяется наличие свежих коммитов, и возвращается список содержащий:
id задачи, название задачи, username_id, username, дата и время последнего коммита,
автор последнего коммита, ссылка на коммит. Проверку необходимо осуществлять только у незасчитанных задач
или у задач отправленных на доработку.

Администратор должен иметь возможность оценить задачу с помощью следующих атрибутов:
зачет/незачёт, комментарий. После проверки создать сообщение пользователю.р
Также администратор может сформировать ведомость по всей стажировке.
В ведомость включаются все студенты и задачи, которые были опубликованы на момент формирования
ведомости. Участник должен иметь возможность посмотреть собственную успеваемость в
пользовательской части.

В пользовательской и административной части должна быть возможность
получать все сообщения пользователя.

# Отчёт

# Промежуточный результат №1

## БД

Начал со структуры бд, сначала таблицы для сущностей:

- internship - стажировка;
- lesson - занятие;
- task - задача;
- user - пользователь;
- role - роли для Security;
- message - сообщения. От кого, кому и содержимое

Далее таблицы связывающие отношения:

- user_internships - участник может проходить несколько стажировок (естественно стажировку проходят много участников);
- user_roles - сейчас предполагаются роли user и admin, так что можно было оставить role как поле у user, но создал доп.
  табличку если вдруг понадобятся дополнительные роли (видел такое в гайдах, так что кажется норм практикой)
- user_tasks - результаты проверки задачи пользователя (задача принята/нет) и т.д.

Итог:
![db.png](https://gitlab.platforma.institute/mikhail.medvedew/project-2024/-/tree/main/db-pngs/db.png "db.png")

## Сущности

Описал все сущности в коде и связал с бд

## Репозитории

Создал JPA репозитории для этих сущностей, добавил доп. методы (например UserRepository.findByUsername для последующего
использования в UserDetailsService)

## Исключения

Для обработки исключений испоьлзую @ControllerAdvice

## DTO, сервисы, контроллеры, мапперы, тесты

По порядку, для каждой сущности создаю сервис -> dto -> маппер -> контроллер

Для сервисов и мапперов добаляю unit тесты

### насчёт мапперов

Во многих мапперах есть доп методы, которые я не комментировал javadoc, их суть заключается в том, что в dto просто
приходит id юзера, а в сущности хранится объект юзера, поэтому в этих методах я создаю юзера с пустыми полями, кроме id

## Security

Соответственно добавил userDetailsService, config, и вспомогательный класс, суть которого заключается в проверке того,
что пользователь хочет получить доступ к своим ресурсам.

# Временный итог

- Пока поддерживаются базовые CRUD операции для сущностей.
- Конфиг security не полный
- Есть нормальный каркас для дальнейшего развития проекта и добавления функциональности

# Промежуточный результат №2

Не учёл то, что у пользователя может быть разный статус для разных стажировок, поэтому изменил структуру бд. Теперь
status хранится не как поле пользователя, а в табличке user-internships. Соответственно добавил сущность и другие классы
для неё.

Изменённая бд

![db.png](https://gitlab.platforma.institute/mikhail.medvedew/project-2024/-/tree/main/db-pngs/db2.png "db.png")

## Добавленные возможности

### Стажировки:

- получить все занятия некоторой стажировки
- получить всех пользователей на некоторой стажировке
- добавить пользователя на стажировку и изменить статус

### Пользователь:

- подать заявку на стажировку
- получить все стажировки пользователя
- получить все сообщения пользователя
- получить все сообщения между двумя пользователями
- получить все отправленные пользователем сообщения
- получить все полученные пользователем сообщения
- отправка сообщения пользователем

### занятия:

- получить все задачи занятия

### также:

- получение пользователей со всех стажировок с определённым статусом (прошёл, отчислен, подал заявку и тп)
- получение пользователей конкретной стажировки с определённым статусом

### security

- изменён вспомогательный класс для security
- Добавлена возможность админам назначать роли пользователям

# Временный итог

- Добавлен функционал для взаимодействия с сущностями, но он не затрагивает часть связанную с
  задачами/gitlab

# Промежуточный результат №3

Проект запускается в docker-compose вместе с другими контейнерами.
Добавлен класс который взаимодействует с gitlab с помощью restTemplate. Также добавлен сервис для более высокого уровня взаимодействия с gitlab. 
Сейчас доступна функциональность:
- создание аккаунта пользователя в gitlab
- публикация занятия (fork репозитория для пользователей учавствующих в стажировке)

В целом проверяю все эндпойнты с помощью postman.

# Промежуточный результат №4
### Добавлены эндпойнты для получения:
- успеваемость пользователя
- ведомость
- получение свежих коммитов пользователя

### Изменение таблицы в бд. 
Теперь user_tasks (результат проверки задачи пользователя) кроме статуса и времени проверки хранит также время создания последнего проверенного коммита. Это необходимо для определения "свежих" коммитов
### БД
![db3.png](https://gitlab.platforma.institute/mikhail.medvedew/project-2024/-/tree/main/db-pngs/db3.png "db3.png")


## Ближайшие цели
По моему локальному списку требований реализован необходимый функционал, но возможно что то было пропущено, так что предстоит верификация требований.

### Тем не менее уже требуются некоторые фиксы 
- пароль пользователя. Dto пользователя включает в себя пароль и при создании пользователя этот пароль проходит encode, однако при обновлении пользователя такого не происходит 
- security. Сейчас пользователь может получить информацию о стажировке для своих данных, даже если он не зачислен на эту стажировку (например результаты проверок задач будут как UNCHECKED).
- проверки. Например, при удалении любой сущности нет проверки того, что эта сущность вообще существует, соответственно вместо NOT_FOUND или NO_CONTENT сейчас проиходит SERVER ERROR

### Рефакторинг
- переработать гитлаб клиент (как минимум вместо false (или возврата null) выбрасывать cheked исключение для сервиса если что то пошло не так)
- переработка internship сервиса (слишком много обязанностей, кажется что нужно создать отдельный сервис для ведомости и успеваемости пользователя)
- маппинг методы вынести в мапперы

### Также
Исправления на возможные комментарии